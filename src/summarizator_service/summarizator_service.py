import os
from openai import AsyncOpenAI
from dotenv import load_dotenv

load_dotenv()

model_name = "openai/gpt-oss-120b"


NEURONET_PROVIDER_TOKEN = os.getenv("NEURONET_PROVIDER_TOKEN")
NEURONET_MODEL_NAME=os.getenv("NEURONET_MODEL_NAME")
NEURONET_PROVIDER_BASE_URL=os.getenv("NEURONET_PROVIDER_BASE_URL")

client = AsyncOpenAI(
    base_url=NEURONET_PROVIDER_BASE_URL,
    api_key=NEURONET_PROVIDER_TOKEN,
)

options = {
    "summarization": """
Суммаризируй данные тебе сообщения из чата.
Сгруппируй их по темам, как считаешь нужным. Избегай шуточных или не важных тем, игнорируй флуд.
По каждой теме кратко опиши её суть и в общих словах ход её обсуждения в чате. Если было обсуждение какого-то вопроса, напиши ответ на него, если он был в чате.
Оформи ответ в виде маркированного списка. Пиши кратко, быть может, опуская детали. Главное, чтобы было понятно о чём шло обсуждение.
Вот сообщения из чата:""",

    "summariation_v2":"""
Ты — аналитик Telegram‑переписок (шумный чат: шутки, оффтоп, несколько параллельных тем, рваный контекст).
Нужно сделать сводку НЕ ВСЕГО чата, а только по указанной теме (topic-focused summary).

ВХОД:
1) Пользователь задаёт ТЕМУ (одна строка).
2) Далее идёт переписка.

ЯЗЫК:
- Ответ всегда на русском.

ВЫХОД (Markdown):
- Без таблиц и без символа “|”.
- Не используй горизонтальные разделители (не пиши отдельные строки из дефисов/черточек/линий).
- Выводи только: заголовок, общий абзац, затем нумерованные пункты.
- Нумерация пунктов строго в формате: 1. 2. 3. (точка после числа, без скобок).
- В каждом нумерованном пункте первое предложение в описании выделяй жирным: сразу после “{Название аспекта}:” оберни первое предложение в **...**. Жирным должно быть только первое предложение, остальной текст пункта — обычный.

ГЛАВНОЕ ПРАВИЛО ФОКУСА:
- Пиши ТОЛЬКО то, что относится к заданной теме.
- Если сообщение не помогает понять тему (факт/условие/решение/вопрос/действие/регламент/дедлайн/техдеталь по теме) — игнорируй.
- “Пункты” в этом режиме — это аспекты/подтемы ОДНОЙ заданной темы (а не темы всего чата).
- Если тема слишком широкая: сгруппируй обсуждение в 4–10 самых важных аспектов, но не выдумывай то, чего не было в чате.
- Если по теме почти ничего нет: честно напиши это в общей сводке и добавь 1–3 пункта с теми редкими упоминаниями, которые нашлись (если нашлись).

АНТИ-ЭХО (ВАЖНО):
- Никогда не цитируй и не пересказывай этот prompt.
- Не выводи слова из инструкций (например: “ФОРМАТ:”, “ПРАВДИВОСТЬ:”, “ШАБЛОН ОТВЕТА”, и т.п.).
- Выводи только итоговую сводку в формате из раздела “ШАБЛОН ОТВЕТА”.

ПРАВДИВОСТЬ:
- Ничего не выдумывай.
- Если данных не хватает — пиши это прямо в тексте (например: “Нужно уточнить …”) строго в рамках темы.

КАК ПИСАТЬ “ПОДРОБНО”, НО АККУРАТНО:
- Внутри пункта допускается мини-структура, только если помогает:
  “Контекст: … / Условия: … / Сроки: … / Что нужно сделать: … / Статус: … / Вопросы: …”.
- Если деталей много, приоритизируй: сроки/правила/что делать/кто ответственный/риски/ссылки.
- Оффтоп/шутки выкидывай, если они не меняют решения/правила/планы по теме.

ССЫЛКИ НА СООБЩЕНИЯ:
- Во входных данных может быть поле link (permalink на сообщение).
- В конце КАЖДОГО пункта добавляй 1–3 кликабельные ссылки (без слов “Источники”, “Ссылки”, “Evidence”).
- НИГДЕ не показывай msg_id/message_id пользователю (никаких #419, #123 и т.п.).
- Нумерация ссылок локальная внутри пункта: [#1], [#2], [#3].
- Формат: ... [#1](URL), [#2](URL), [#3](URL)  (ссылки идут в самом конце пункта одной строкой).
- Если link отсутствует вообще во всём входе — не добавляй ссылки нигде.

КАК ВЫБИРАТЬ 1–3 ССЫЛКИ:
- Не больше 3 ссылок ни при каких условиях.
- Выбирай самые “сильные” сообщения по теме:
  1) Явное решение/итог/договорённость по теме.
  2) Дата/дедлайн/условия/регламент по теме.
  3) Конкретное поручение/что сделать по теме.
  4) Финальный ответ на ключевой вопрос по теме.
  5) Критичная техдеталь по теме (ошибка, команда, параметр, ссылка на ресурс).
- Если несколько сообщений повторяют одно и то же — оставь только самое информативное.

ОГРАНИЧЕНИЕ ПО РАЗМЕРУ:
- Стремись уложиться в одно сообщение (ориентир 2500–3500 символов).
- Если аспектов слишком много — выбери 6–10 самых важных.

ШАБЛОН ОТВЕТА (строго следуй ему; никаких дополнительных строк/секций вне шаблона):

{ЗАГОЛОВОК 4–8 слов, явно связанный с темой}

{ОБЩАЯ СВОДКА: 3–4 предложения ТОЛЬКО по теме: что выяснили, какие решения/правила/условия, что осталось неясным.}

1. {Название аспекта}: **{Первое предложение по делу.}** {Дальше подробности по делу (сколько нужно). Допускается мини-структура короткими фразами: “Контекст: … Сроки: … Условия: … Что дальше: …”.} [#1](...), [#2](...), [#3](...)

2. {Название аспекта}: **{Первое предложение по делу.}** {Дальше подробное изложение по делу.} [#1](...), [#2](...)

3. {Название аспекта}: **{Первое предложение по делу.}** {Дальше подробное изложение по делу.} [#1](...)

...
"""
}

class SummarizationService:
    """Асинхронный сервис для суммаризации сообщений через LLM"""

    def __init__(self, model: str = NEURONET_MODEL_NAME):
        self.model = model

    async def summarize(self, messages: list[str]) -> str | None:
        """
        Асинхронно делает суммаризацию списка сообщений.
        """
        prompt = options['summarization']
        prompt += "\n".join(messages)

        completion = await client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
        )

        return completion.choices[0].message.content
    
    async def summarize_v2(self, messages: list[str]) -> str | None:
        system_prompt = options['summariation_v2']

        user_prompt = '\n'.join(messages)

        completion = await client.chat.completions.create(
            model=self.model,
            messages=[
                {
                    'role': 'system',
                    "content": system_prompt
                },
                {
                    'role': 'user',
                    'content': user_prompt
                }
            ],
        )

        return completion.choices[0].message.content
